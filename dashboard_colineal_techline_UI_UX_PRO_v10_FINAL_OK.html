<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuestas Colineal - Techline</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3d;
            --bg-card: #1a2349;
            --text-primary: #ffffff;
            --text-secondary: #b4bcd0;
            --border-color: #2d3561;
            --shadow-lg: 0 8px 32px rgba(0, 255, 255, 0.2);
            --shadow-xl: 0 16px 48px rgba(0, 255, 255, 0.25);
            --neon-blue: #00f0ff;
            --neon-purple: #b000ff;
            --neon-pink: #ff006e;
            --accent-primary: #00d4ff;
            --accent-secondary: #8a2be2;
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
        }

        [data-theme="light"] {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1f36;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.2);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1f3a 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.4s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, rgba(0, 212, 255, 0.15), transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.15), transparent 40%);
            pointer-events: none;
            z-index: 0;
            animation: backgroundPulse 20s ease-in-out infinite;
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .loader-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .loader-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .neon-logo {
            font-size: 4rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.3rem;
            text-align: center;
            line-height: 1.2;
            color: #fff;
            text-shadow: 0 0 10px #00f0ff, 0 0 20px #00f0ff, 0 0 40px #00d4ff, 0 0 80px #00d4ff;
            animation: neonFlicker 3s ease-in-out infinite;
        }

        @keyframes neonFlicker {
            0%, 100% { text-shadow: 0 0 10px #00f0ff, 0 0 20px #00f0ff, 0 0 40px #00d4ff, 0 0 80px #00d4ff; }
            50% { text-shadow: 0 0 5px #00f0ff, 0 0 15px #00f0ff, 0 0 30px #00d4ff, 0 0 60px #00d4ff; }
        }

        .neon-subtitle {
            margin-top: 1rem;
            font-size: 1.2rem;
            color: #b4bcd0;
            text-shadow: 0 0 10px #8a2be2, 0 0 20px #8a2be2;
            letter-spacing: 0.2rem;
        }

        .loader-spinner {
            margin-top: 3rem;
            width: 80px;
            height: 80px;
            border: 4px solid transparent;
            border-top-color: #00f0ff;
            border-right-color: #b000ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loader-progress {
            margin-top: 2rem;
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00f0ff, #b000ff, #ff006e);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.6);
        }

        .loader-text {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .container.visible { opacity: 1; }

        .header {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple), var(--neon-pink));
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
        }

        .logo-container i {
            font-size: 2.5rem;
            color: white;
        }

        .title-group h1 {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .title-group p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            border-color: var(--accent-primary);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { transform: translateY(-2px); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover { transform: translateY(-5px); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .stat-icon.blue { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .stat-icon.green { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .stat-icon.orange { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .stat-icon.pink { background: linear-gradient(135deg, #ec4899, #db2777); color: white; }
        .stat-icon.cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }

        .stat-content h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        .filters-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 10px;
            font-size: 0.95rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        
            align-items: start;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        
            align-self: start;
        }

        .chart-card:hover { transform: translateY(-5px); }

        .chart-card.full-width { grid-column: 1 / -1; }

        .chart-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .chart-header h2 {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small { height: 300px; }
        .chart-container.large { height: 500px; }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .neon-logo { font-size: 2.5rem; }
        }
    
        /* üîß FIX: Mantener tarjetas una al lado de otra */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

    
        /* üî• Tarjeta ancha (full width) tipo P2 */
        .chart-card.full-width {
            grid-column: 1 / -1;
        }

    
        /* ================================
           ‚ú® UI/UX Enhancements (sin cambiar el estilo)
           ================================ */

        html { scroll-behavior: smooth; }

        /* Micro-interacciones: botones */
        .btn, .theme-toggle {
            position: relative;
            overflow: hidden;
            will-change: transform;
        }
        .btn:active, .theme-toggle:active { transform: translateY(0px) scale(0.98); }

        .btn::after, .theme-toggle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: rgba(255,255,255,0.18);
            border-radius: 999px;
            transform: translate(-50%,-50%) scale(0);
            opacity: 0;
            transition: transform .55s ease, opacity .65s ease;
            pointer-events: none;
        }
        .btn:hover::after, .theme-toggle:hover::after {
            transform: translate(-50%,-50%) scale(30);
            opacity: 1;
        }

        /* Tarjetas: glow y reveal sutil */
        .stat-card, .chart-card, .filters-section, .header {
            will-change: transform, opacity;
        }

        .stat-card, .chart-card {
            transition: transform .28s ease, box-shadow .28s ease, border-color .28s ease, opacity .6s ease, filter .6s ease;
        }
        .stat-card:hover, .chart-card:hover {
            border-color: rgba(0, 212, 255, 0.45);
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.20);
            transform: translateY(-6px);
        }

        /* Reveal on scroll */
        .reveal {
            opacity: 0;
            transform: translateY(14px);
            filter: blur(1.5px);
        }
        .reveal.revealed {
            opacity: 1;
            transform: translateY(0);
            filter: blur(0);
        }

        /* Canvas: entrada suave */
        canvas {
            opacity: 0;
            transform: translateY(6px);
            transition: opacity .55s ease, transform .55s ease;
        }
        .revealed canvas {
            opacity: 1;
            transform: translateY(0);
        }

        /* Focus accesible (UX) */
        button:focus-visible, select:focus-visible, input:focus-visible {
            outline: 2px solid rgba(0, 212, 255, 0.65);
            outline-offset: 2px;
            border-color: rgba(0, 212, 255, 0.55);
        }

        /* Preferencias de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            html { scroll-behavior: auto; }
            .stat-card, .chart-card, .btn, .theme-toggle, canvas, .reveal {
                transition: none !important;
                animation: none !important;
            }
            .reveal { opacity: 1; transform: none; filter: none; }
            canvas { opacity: 1; transform: none; }
        }

    
        /* ================================
           üöÄ Loader mejorado (Ne√≥n estilo video)
           ================================ */
        .loader-screen::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                repeating-linear-gradient(
                    to bottom,
                    rgba(255,255,255,0.035) 0px,
                    rgba(255,255,255,0.035) 1px,
                    transparent 3px,
                    transparent 6px
                );
            mix-blend-mode: overlay;
            opacity: 0.35;
            animation: scanlines 2.2s linear infinite;
        }

        .loader-screen::before {
            content: '';
            position: fixed;
            inset: -20%;
            pointer-events: none;
            background:
                radial-gradient(circle at 25% 30%, rgba(0, 240, 255, 0.22), transparent 45%),
                radial-gradient(circle at 75% 70%, rgba(176, 0, 255, 0.18), transparent 46%),
                radial-gradient(circle at 60% 20%, rgba(255, 0, 110, 0.12), transparent 55%);
            filter: blur(0px);
            opacity: 0.9;
            animation: nebulaMove 7.5s ease-in-out infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(-8px); }
            100% { transform: translateY(8px); }
        }
        @keyframes nebulaMove {
            0%, 100% { transform: translate3d(0,0,0) scale(1.02); }
            50% { transform: translate3d(-1.5%, 1.5%, 0) scale(1.06); }
        }

        .neon-logo {
            position: relative;
            isolation: isolate;
            animation: neonFlicker 3s ease-in-out infinite, floatLogo 2.8s ease-in-out infinite;
        }

        /* Haz de luz que pasa sobre el texto */
        .neon-logo::after {
            content: '';
            position: absolute;
            inset: -8px -18px;
            background: linear-gradient(120deg,
                transparent 0%,
                rgba(0,240,255,0.10) 35%,
                rgba(176,0,255,0.12) 50%,
                rgba(255,0,110,0.10) 65%,
                transparent 100%
            );
            transform: translateX(-120%) skewX(-18deg);
            filter: blur(2px);
            opacity: 0.85;
            z-index: -1;
            animation: lightSweep 1.9s ease-in-out infinite;
        }

        /* Glow externo ‚Äúvideo‚Äù */
        .neon-logo::before {
            content: '';
            position: absolute;
            inset: -22px -26px;
            border-radius: 18px;
            background: radial-gradient(circle at 30% 30%, rgba(0,240,255,0.18), transparent 55%),
                        radial-gradient(circle at 70% 70%, rgba(176,0,255,0.16), transparent 55%);
            filter: blur(10px);
            opacity: 0.85;
            z-index: -2;
            animation: haloPulse 2.6s ease-in-out infinite;
        }

        @keyframes floatLogo {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes lightSweep {
            0% { transform: translateX(-120%) skewX(-18deg); opacity: 0.4; }
            45% { opacity: 0.95; }
            100% { transform: translateX(120%) skewX(-18deg); opacity: 0.4; }
        }
        @keyframes haloPulse {
            0%, 100% { opacity: 0.65; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.04); }
        }

        /* Barra de progreso con movimiento continuo */
        .loader-progress-bar {
            background: linear-gradient(90deg, #00f0ff, #b000ff, #ff006e, #00f0ff);
            background-size: 220% 100%;
            animation: progressGlow 1.1s linear infinite;
        }
        @keyframes progressGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

    
        /* ================================
           ‚ú® Est√©tica extra (sin cambiar layout)
           ================================ */
        .chart-header h2 {
            position: relative;
        }
        .chart-header h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -10px;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(0,240,255,0.35), rgba(176,0,255,0.35), transparent);
            opacity: 0.45;
        }

        /* Borde ‚Äúne√≥n‚Äù al pasar */
        .chart-card:hover::before,
        .stat-card:hover::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 20px;
            background: linear-gradient(90deg, rgba(0,240,255,0.28), rgba(176,0,255,0.22), rgba(255,0,110,0.18));
            filter: blur(10px);
            opacity: 0.55;
            z-index: -1;
        }

        .chart-card, .stat-card {
            position: relative;
        }

    
        }

    
        /* ================================
           üåà Header animado (barra multicolor + movimiento sutil)
           ================================ */
        .header::before {
            background-size: 220% 100%;
            animation: headerGlowMove 3.2s linear infinite;
        }
        @keyframes headerGlowMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* Brillo suave que recorre el header */
        .header::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 24px;
            pointer-events: none;
            background: linear-gradient(120deg,
                transparent 0%,
                rgba(0,240,255,0.10) 35%,
                rgba(176,0,255,0.10) 50%,
                rgba(255,0,110,0.08) 65%,
                transparent 100%
            );
            transform: translateX(-120%) skewX(-18deg);
            filter: blur(2px);
            opacity: 0.55;
            animation: headerSweep 4.2s ease-in-out infinite;
        }
        @keyframes headerSweep {
            0% { transform: translateX(-120%) skewX(-18deg); opacity: 0.25; }
            40% { opacity: 0.65; }
            100% { transform: translateX(120%) skewX(-18deg); opacity: 0.25; }
        }

        /* Logo: flotaci√≥n y gradiente animado */
        .logo-container {
            background-size: 220% 220%;
            animation: logoFloat 3.0s ease-in-out infinite, logoGradient 2.8s linear infinite;
        }
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes logoGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* T√≠tulo: micro shimmer */
        .title-group h1 {
            background-size: 220% 100%;
            animation: titleShimmer 4.8s ease-in-out infinite;
        }
        @keyframes titleShimmer {
            0%, 100% { background-position: 0% 50%; filter: drop-shadow(0 0 0 rgba(0,240,255,0)); }
            50% { background-position: 100% 50%; filter: drop-shadow(0 0 10px rgba(0,240,255,0.18)); }
        }

    
        /* ‚úÖ PREGUNTAS 0-10: Mostrar Vista General + Detalle lado a lado */
        #scaleQuestionsGrid { 
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        .q-pair {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 25px;
            align-items: start;
        }
        @media (max-width: 1100px) {
            .q-pair { grid-template-columns: 1fr; }
        }

    
        /* ‚úÖ FIX: Aprovechar mejor pantallas anchas (sin cambiar estilo) */
        .container {
            max-width: 2400px; /* antes 1800px */
            width: min(2400px, calc(100vw - 40px));
        }

    
        /* ‚úÖ FIX FINAL: Que los pares ocupen TODO el ancho disponible */
        #scaleQuestionsGrid { width: 100%; }
        .q-pair { width: 100%; grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .q-pair > .chart-card { width: 100%; min-width: 0; }

        /* ‚úÖ Container sin l√≠mite para pantallas anchas */
        .container {
            max-width: none !important;
            width: calc(100vw - 40px) !important;
        }

    
        /* ‚úÖ LAYOUT FINAL: 2 columnas siempre + evitar huecos en √∫ltima tarjeta */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 25px;
            align-items: start;
            width: 100%;
        }
        /* Si una tarjeta queda sola al final (cantidad impar), que ocupe todo el ancho */
        .charts-grid > .chart-card:only-child,
        .charts-grid > .chart-card:nth-last-child(1):nth-child(odd) {
            grid-column: 1 / -1;
        }
        /* Mantener full-width expl√≠cito */
        .chart-card.full-width { grid-column: 1 / -1; }

        /* En pantallas peque√±as: 1 columna */
        @media (max-width: 1100px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* PREGUNTAS 0-10: el par siempre 50/50 y ocupa todo */
        #scaleQuestionsGrid { width: 100%; }
        .q-pair {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 25px;
            align-items: start;
            grid-column: 1 / -1;
        }
        @media (max-width: 1100px) { .q-pair { grid-template-columns: 1fr; } }

    </style>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <div class="loader-screen" id="loaderScreen">
        <div class="neon-logo">COLINEAL<br>ANALYTICS</div>
        <p class="neon-subtitle">2026</p>
        <div class="loader-spinner"></div>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="loaderProgressBar"></div>
        </div>
        <p class="loader-text" id="loaderText">Cargando datos...</p>
    </div>

    <div class="container" id="mainContainer">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <div class="logo-container">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="title-group">
                        <h1>Encuestas Colineal</h1>
                        <p>Dashboard de An√°lisis de Satisfacci√≥n del Cliente</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button class="btn" id="exportBtn">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>

        <div class="filters-section">
            <h2 style="color: var(--text-primary); margin-bottom: 10px;">
                <i class="fas fa-filter"></i> Filtros
            </h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Ciudad</label>
                    <select id="filterCity"><option value="">Todas</option></select>
                </div>
                <div class="filter-group">
                    <label>Agente</label>
                    <select id="filterAgent"><option value="">Todos</option></select>
                </div>
                <div class="filter-group">
                    <label>Forma de Compra</label>
                    <select id="filterPurchaseType"><option value="">Todas</option></select>
                </div>
                <div class="filter-group">
                    <label>Fecha Desde</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="filter-group">
                    <label>Fecha Hasta</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn" id="applyFilters">
                        <i class="fas fa-check"></i> Aplicar
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                </div>
                <div class="stat-content">
                    <h3>Total Encuestas</h3>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-change positive"><i class="fas fa-check"></i> Completadas</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon green"><i class="fas fa-star"></i></div>
                </div>
                <div class="stat-content">
                    <h3>NPS Score</h3>
                    <div class="stat-value" id="statNPS">0</div>
                    <div class="stat-change" id="npsChange"></div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon purple"><i class="fas fa-smile"></i></div>
                </div>
                <div class="stat-content">
                    <h3>Satisfacci√≥n Promedio</h3>
                    <div class="stat-value" id="statSat">0</div>
                    <div class="stat-change positive"><i class="fas fa-arrow-up"></i> /10</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon orange"><i class="fas fa-redo"></i></div>
                </div>
                <div class="stat-content">
                    <h3>Recompra Promedio</h3>
                    <div class="stat-value" id="statRec">0</div>
                    <div class="stat-change positive"><i class="fas fa-arrow-up"></i> /10</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon pink"><i class="fas fa-exclamation-triangle"></i></div>
                </div>
                <div class="stat-content">
                    <h3>% con Problemas</h3>
                    <div class="stat-value" id="statProb">0%</div>
                    <div class="stat-change" id="probChange"></div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon cyan"><i class="fas fa-store"></i></div>
                </div>
                <div class="stat-content">
                    <h3>Compra Presencial</h3>
                    <div class="stat-value" id="statPres">0%</div>
                    <div class="stat-change positive"><i class="fas fa-check"></i> Principal</div>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-chart-pie"></i> Distribuci√≥n NPS</h2>
                    <p>Promotores, Pasivos y Detractores</p>
                </div>
                <div class="chart-container"><canvas id="npsChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-map-marker-alt"></i> Satisfacci√≥n por Ciudad</h2>
                    <p>Promedio de satisfacci√≥n general</p>
                </div>
                <div class="chart-container"><canvas id="cityChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-thumbs-up"></i> P2: Recomendaci√≥n (Vista General)</h2>
                    <p>Distribuci√≥n en categor√≠as NPS</p>
                </div>
                <div class="chart-container"><canvas id="recPieChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-chart-bar"></i> P2: Recomendaci√≥n (Detalle)</h2>
                    <p>Cantidad por puntuaci√≥n (0-10)</p>
                </div>
                <div class="chart-container"><canvas id="recBarChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-smile"></i> P1: Satisfacci√≥n General</h2>
                    <p>Distribuci√≥n de satisfacci√≥n (0-10)</p>
                </div>
                <div class="chart-container"><canvas id="satChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-redo"></i> P4: Intenci√≥n de Recompra</h2>
                    <p>Distribuci√≥n de intenci√≥n (0-10)</p>
                </div>
                <div class="chart-container"><canvas id="repChart"></canvas></div>
            </div>

            <div class="chart-card full-width">
                <div class="chart-header">
                    <h2><i class="fas fa-star-half-alt"></i> P9: Satisfacci√≥n por Atributos</h2>
                    <p>Con total de respuestas y porcentaje de participaci√≥n</p>
                </div>
                <div class="chart-container large"><canvas id="attrChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-check-circle"></i> P6, P7, P8: Afirmaciones</h2>
                    <p>Nivel de acuerdo</p>
                </div>
                <div class="chart-container small"><canvas id="stmtChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-shopping-cart"></i> Forma de Compra</h2>
                    <p>Canales utilizados</p>
                </div>
                <div class="chart-container small"><canvas id="purChart"></canvas></div>
            </div>

            
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h2><i class="fas fa-bug"></i> P10: Problemas Reportados</h2>
                    <p>Con vs Sin problemas</p>
                </div>
                <div class="chart-container small"><canvas id="probChart"></canvas></div>
            </div>

        
        </div>

        <!-- üîΩ PREGUNTAS ESCALA 0-10 (AUTOGENERADAS) -->
        <div id="scaleQuestionsGrid"></div>

    </div>

    <script>
        const SHEET_ID = '1M5IKFfEcNTjvfMqSsm1FKFZUQm9wVxpi4DZ1bGA0fr0';
        const SHEET_GID = '758683711';
        
        let allData = [];
        let filteredData = [];
        let charts = {};


        // ================================
        // ‚ú® UX: Reveal animaciones al hacer scroll (sin cambiar el dise√±o)
        // ================================
        function setupRevealAnimations() {
            const els = document.querySelectorAll('.stat-card, .chart-card, .filters-section, .header');
            els.forEach(el => el.classList.add('reveal'));

            // Si el navegador no soporta IntersectionObserver, mostramos todo.
            if (!('IntersectionObserver' in window)) {
                els.forEach(el => el.classList.add('revealed'));
                return;
            }

            const obs = new IntersectionObserver((entries) => {
                entries.forEach(e => {
                    if (e.isIntersecting) {
                        e.target.classList.add('revealed');
                        obs.unobserve(e.target);
                    }
                });
            }, { threshold: 0.12 });

            els.forEach(el => obs.observe(el));
        }


        function updateLoader(pct, txt) {
            document.getElementById('loaderProgressBar').style.width = pct + '%';
            document.getElementById('loaderText').textContent = txt;
        }

        function hideLoader() {
            updateLoader(100, 'Completado!');
            setTimeout(() => {
                document.getElementById('loaderScreen').classList.add('hidden');
                document.getElementById('mainContainer').classList.add('visible');
            }, 800);
        }

        document.getElementById('themeToggle').addEventListener('click', function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            this.querySelector('i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        });

        async function loadData() {
            updateLoader(10, 'Conectando...');
            
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
                updateLoader(30, 'Descargando...');
                
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                updateLoader(50, 'Procesando...');
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allData = results.data;
                        filteredData = [...allData];
                        
                        updateLoader(70, 'Inicializando...');
                        initFilters();
                        updateLoader(85, 'Generando gr√°ficas...');
                        updateDashboard();
            setupRevealAnimations();
                        setupRevealAnimations();
                        hideLoader();
                    }
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar datos');
            }
        }

        function initFilters() {
            const cities = [...new Set(allData.map(r => r.Ciudad).filter(Boolean))];
            const agents = [...new Set(allData.map(r => r['Nombre del agente']).filter(Boolean))];
            const purchase = [...new Set(allData.map(r => r['Forma de realizaci√≥n de compra']).filter(Boolean))];

            cities.sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                document.getElementById('filterCity').appendChild(opt);
            });

            agents.sort().forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = a;
                document.getElementById('filterAgent').appendChild(opt);
            });

            purchase.sort().forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                document.getElementById('filterPurchaseType').appendChild(opt);
            });
        }

        document.getElementById('applyFilters').addEventListener('click', () => {
            const city = document.getElementById('filterCity').value;
            const agent = document.getElementById('filterAgent').value;
            const purchase = document.getElementById('filterPurchaseType').value;
            const from = document.getElementById('filterDateFrom').value;
            const to = document.getElementById('filterDateTo').value;

            filteredData = allData.filter(row => {
                if (city && row.Ciudad !== city) return false;
                if (agent && row['Nombre del agente'] !== agent) return false;
                if (purchase && row['Forma de realizaci√≥n de compra'] !== purchase) return false;
                if (from || to) {
                    const date = new Date(row.Timestamp);
                    if (from && date < new Date(from)) return false;
                    if (to && date > new Date(to)) return false;
                }
                return true;
            });

            updateDashboard();
        });

        document.getElementById('refreshBtn').addEventListener('click', () => loadData());

        document.getElementById('exportBtn').addEventListener('click', () => {
            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `encuestas_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });

        function getCol(partial) {
            return Object.keys(filteredData[0] || {}).find(k => k.includes(partial)) || '';
        }

        
        // ================================
        // üî• AUTO TARJETAS ESCALA 0‚Äì10
        // ================================
        function renderScaleQuestions() {
            const container = document.getElementById('scaleQuestionsGrid');
            if (!container || !filteredData.length) return;

            container.innerHTML = '';
            const sample = filteredData[0];

            const scaleQuestions = Object.keys(sample).filter(col => {
                if (!/^P\d+/i.test(col)) return false;
                const vals = filteredData.map(r => r[col]).filter(v => v !== null && v !== undefined);
                return vals.length && vals.every(v => typeof v === 'number' && v >= 0 && v <= 10);
            });

            scaleQuestions.forEach(col => {
                const dist = Array(11).fill(0);
                filteredData.forEach(r => {
                    const v = r[col];
                    if (v >= 0 && v <= 10) dist[v]++;
                });

                const prom = dist.slice(9).reduce((a,b)=>a+b,0);
                const pass = dist.slice(7,9).reduce((a,b)=>a+b,0);
                const det  = dist.slice(0,7).reduce((a,b)=>a+b,0);

                const id = col.replace(/\W/g,'_');

                container.insertAdjacentHTML('beforeend', `

                <div class="q-pair">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h2><i class="fas fa-thumbs-up"></i> ${col} (Vista General)</h2>
                            <p>Distribuci√≥n tipo NPS</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="${id}_pie"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h2><i class="fas fa-chart-bar"></i> ${col} (Detalle)</h2>
                            <p>Distribuci√≥n por puntuaci√≥n (0‚Äì10)</p>
                        </div>
                        <div class="chart-container">
                            <canvas id="${id}_bar"></canvas>
                        </div>
                    </div>
                </div>
    
                `);
            new Chart(document.getElementById(`${id}_pie`), {
                    type: 'pie',
                    data: {
                        labels: ['Promotores (9-10)', 'Pasivos (7-8)', 'Detractores (0-6)'],
                        datasets: [{
                            data: [prom, pass, det],
                            backgroundColor: [
                                'rgba(16,185,129,0.8)',
                                'rgba(245,158,11,0.8)',
                                'rgba(239,68,68,0.8)'
                            ]
                        }]
                    },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
                });

                new Chart(document.getElementById(`${id}_bar`), {
                    type: 'bar',
                    data: {
                        labels: ['0','1','2','3','4','5','6','7','8','9','10'],
                        datasets: [{
                            data: dist,
                            backgroundColor: dist.map((_,i)=>
                                i>=9 ? 'rgba(16,185,129,0.8)' :
                                i>=7 ? 'rgba(245,158,11,0.8)' :
                                       'rgba(239,68,68,0.8)'
                            ),
                            borderRadius: 6
                        }]
                    },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
                });
            });
        }


        function updateDashboard() {
            const total = filteredData.length;
            
            // P1
            const p1Col = getCol('P1.');
            const p1Vals = filteredData.map(r => r[p1Col]).filter(v => v > 0);
            const avgSat = p1Vals.length > 0 ? (p1Vals.reduce((a,b)=>a+b,0) / p1Vals.length).toFixed(1) : 0;
            
            // P2 - NPS
            const p2Col = getCol('P2.');
            const p2Vals = filteredData.map(r => r[p2Col]).filter(v => v !== null && v !== undefined);
            const promoters = p2Vals.filter(v => v >= 9).length;
            const passives = p2Vals.filter(v => v >= 7 && v < 9).length;
            const detractors = p2Vals.filter(v => v < 7).length;
            const nps = total > 0 ? Math.round(((promoters - detractors) / total) * 100) : 0;
            
            // P4
            const p4Col = getCol('P4.');
            const p4Vals = filteredData.map(r => r[p4Col]).filter(v => v > 0);
            const avgRep = p4Vals.length > 0 ? (p4Vals.reduce((a,b)=>a+b,0) / p4Vals.length).toFixed(1) : 0;
            
            // P10
            const p10Col = getCol('P10.');
            const withProb = filteredData.filter(r => r[p10Col] && r[p10Col].toLowerCase().includes('s√≠')).length;
            const probPct = total > 0 ? ((withProb / total) * 100).toFixed(1) : 0;
            
            // Presencial
            const purCol = getCol('Forma de realizaci√≥n');
            const presencial = filteredData.filter(r => r[purCol] === 'Presencial').length;
            const presPct = total > 0 ? ((presencial / total) * 100).toFixed(1) : 0;

            // Update stats
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statNPS').textContent = nps;
            document.getElementById('statSat').textContent = avgSat;
            document.getElementById('statRec').textContent = avgRep;
            document.getElementById('statProb').textContent = probPct + '%';
            document.getElementById('statPres').textContent = presPct + '%';

            const npsChange = document.getElementById('npsChange');
            if (nps >= 50) {
                npsChange.className = 'stat-change positive';
                npsChange.innerHTML = '<i class="fas fa-arrow-up"></i> Excelente';
            } else if (nps >= 0) {
                npsChange.className = 'stat-change';
                npsChange.innerHTML = '<i class="fas fa-minus"></i> Bueno';
            } else {
                npsChange.className = 'stat-change negative';
                npsChange.innerHTML = '<i class="fas fa-arrow-down"></i> Mejorar';
            }

            document.getElementById('probChange').innerHTML = `<i class="fas fa-info-circle"></i> ${withProb} reportados`;

            // Update charts
            updateNPSChart(promoters, passives, detractors);
            updateCityChart(p1Col);
            updateRecCharts(p2Col, p2Vals);
            updateSatChart(p1Col);
            updateRepChart(p4Col);
            updateAttrChart();
            updateStmtChart();
            updatePurChart(purCol);
            updateProbChart(p10Col);

            renderScaleQuestions();
        }

        function updateNPSChart(prom, pass, det) {
            const ctx = document.getElementById('npsChart');
            if (charts.nps) charts.nps.destroy();
            
            charts.nps = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Promotores (9-10)', 'Pasivos (7-8)', 'Detractores (0-6)'],
                    datasets: [{
                        data: [prom, pass, det],
                        backgroundColor: ['rgba(16,185,129,0.8)', 'rgba(245,158,11,0.8)', 'rgba(239,68,68,0.8)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'), padding: 15 } }
                    }
                }
            });
        }

        function updateCityChart(col) {
            const ctx = document.getElementById('cityChart');
            const cityData = {};
            
            filteredData.forEach(r => {
                const city = r.Ciudad;
                const sat = r[col];
                if (city && sat > 0) {
                    if (!cityData[city]) cityData[city] = { sum: 0, count: 0 };
                    cityData[city].sum += sat;
                    cityData[city].count++;
                }
            });

            const cities = Object.keys(cityData);
            const avgs = cities.map(c => (cityData[c].sum / cityData[c].count).toFixed(1));

            if (charts.city) charts.city.destroy();
            
            charts.city = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities,
                    datasets: [{
                        label: 'Promedio',
                        data: avgs,
                        backgroundColor: 'rgba(102,126,234,0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 10, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } }
                    }
                }
            });
        }

        function updateRecCharts(col, vals) {
            const dist = Array(11).fill(0);
            filteredData.forEach(r => {
                const v = r[col];
                if (v !== null && v !== undefined && v >= 0 && v <= 10) dist[v]++;
            });

            const prom = dist.slice(9).reduce((a,b)=>a+b,0);
            const pass = dist.slice(7,9).reduce((a,b)=>a+b,0);
            const det = dist.slice(0,7).reduce((a,b)=>a+b,0);

            // Pie
            const ctxPie = document.getElementById('recPieChart');
            if (charts.recPie) charts.recPie.destroy();
            
            charts.recPie = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['Promotores (9-10)', 'Pasivos (7-8)', 'Detractores (0-6)'],
                    datasets: [{
                        data: [prom, pass, det],
                        backgroundColor: ['rgba(16,185,129,0.8)', 'rgba(245,158,11,0.8)', 'rgba(239,68,68,0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } } }
                }
            });

            // Bar
            const ctxBar = document.getElementById('recBarChart');
            if (charts.recBar) charts.recBar.destroy();
            
            charts.recBar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['0','1','2','3','4','5','6','7','8','9','10'],
                    datasets: [{
                        label: 'Cantidad',
                        data: dist,
                        backgroundColor: dist.map((_,i) => i>=9 ? 'rgba(16,185,129,0.8)' : i>=7 ? 'rgba(245,158,11,0.8)' : 'rgba(239,68,68,0.8)'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } }
                    }
                }
            });
        }

        function updateSatChart(col) {
            const dist = Array(11).fill(0);
            filteredData.forEach(r => {
                const v = r[col];
                if (v >= 0 && v <= 10) dist[v]++;
            });

            const ctx = document.getElementById('satChart');
            if (charts.sat) charts.sat.destroy();
            
            charts.sat = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0','1','2','3','4','5','6','7','8','9','10'],
                    datasets: [{
                        label: 'Cantidad',
                        data: dist,
                        backgroundColor: 'rgba(139,92,246,0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } }
                    }
                }
            });
        }

        function updateRepChart(col) {
            const dist = Array(11).fill(0);
            filteredData.forEach(r => {
                const v = r[col];
                if (v >= 0 && v <= 10) dist[v]++;
            });

            const ctx = document.getElementById('repChart');
            if (charts.rep) charts.rep.destroy();
            
            charts.rep = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0','1','2','3','4','5','6','7','8','9','10'],
                    datasets: [{
                        label: 'Cantidad',
                        data: dist,
                        backgroundColor: 'rgba(245,158,11,0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } }
                    }
                }
            });
        }

        function updateAttrChart() {
            const attrs = [
                'Calidad y durabilidad', 'Comodidad', 'Facilidad de compra', 'Asesor√≠a del vendedor',
                'Dise√±o y estilo', 'Variedad', 'Stock', 'Garant√≠a', 'Tiempo de entrega',
                'Puntualidad', 'Precio', 'Condiciones del producto', 'Servicio del transportista',
                'Marca', 'Formas de pago', 'Funcionalidad'
            ];

            const avgs = [];
            const totals = [];
            const pcts = [];

            attrs.forEach(attr => {
                const col = getCol(`[${attr}]`);
                if (col) {
                    const vals = filteredData.map(r => r[col]).filter(v => v > 0);
                    const avg = vals.length > 0 ? vals.reduce((a,b)=>a+b,0) / vals.length : 0;
                    const pct = (vals.length / filteredData.length * 100);
                    avgs.push(avg.toFixed(2));
                    totals.push(vals.length);
                    pcts.push(pct.toFixed(1));
                } else {
                    avgs.push(0);
                    totals.push(0);
                    pcts.push(0);
                }
            });

            const ctx = document.getElementById('attrChart');
            if (charts.attr) charts.attr.destroy();
            
            charts.attr = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: attrs,
                    datasets: [{
                        label: 'Promedio',
                        data: avgs,
                        backgroundColor: 'rgba(139,92,246,0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const i = ctx.dataIndex;
                                    return [
                                        `Promedio: ${avgs[i]}/10`,
                                        `Total: ${totals[i]} respuestas`,
                                        `Porcentaje: ${pcts[i]}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 10, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        y: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'), font: { size: 11 } } }
                    }
                }
            });
        }

        function updateStmtChart() {
            const p6Col = getCol('P6. Colineal resuelve');
            const p7Col = getCol('P7. Trabajar con Colineal');
            const p8Col = getCol('P8. Me hicieron sentir');

            const p6Avg = filteredData.map(r => r[p6Col]).filter(v => v > 0).reduce((a,b,_,arr) => a + b/arr.length, 0);
            const p7Avg = filteredData.map(r => r[p7Col]).filter(v => v > 0).reduce((a,b,_,arr) => a + b/arr.length, 0);
            const p8Avg = filteredData.map(r => r[p8Col]).filter(v => v > 0).reduce((a,b,_,arr) => a + b/arr.length, 0);

            const ctx = document.getElementById('stmtChart');
            if (charts.stmt) charts.stmt.destroy();
            
            charts.stmt = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Resuelve necesidades', 'F√°cil y simple', 'Me hicieron sentir importante'],
                    datasets: [{
                        label: 'Promedio',
                        data: [p6Avg.toFixed(2), p7Avg.toFixed(2), p8Avg.toFixed(2)],
                        backgroundColor: ['rgba(59,130,246,0.8)', 'rgba(16,185,129,0.8)', 'rgba(236,72,153,0.8)'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 10, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } }
                    }
                }
            });
        }

        function updatePurChart(col) {
            const purData = {};
            filteredData.forEach(r => {
                const p = r[col];
                if (p) purData[p] = (purData[p] || 0) + 1;
            });

            const ctx = document.getElementById('purChart');
            if (charts.pur) charts.pur.destroy();
            
            charts.pur = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(purData),
                    datasets: [{
                        data: Object.values(purData),
                        backgroundColor: ['rgba(59,130,246,0.8)', 'rgba(16,185,129,0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } } }
                }
            });
        }

        function updateProbChart(col) {
            let withProb = 0;
            let withoutProb = 0;

            filteredData.forEach(r => {
                const p = r[col];
                if (p && p.toLowerCase().includes('s√≠')) withProb++;
                else if (p && p.toLowerCase().includes('no')) withoutProb++;
            });

            const ctx = document.getElementById('probChart');
            if (charts.prob) charts.prob.destroy();
            
            charts.prob = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Con Problemas', 'Sin Problemas'],
                    datasets: [{
                        data: [withProb, withoutProb],
                        backgroundColor: ['rgba(239,68,68,0.8)', 'rgba(16,185,129,0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } } }
                }
            });
        }

        window.addEventListener('load', loadData);
    </script>

<script>
if (window.Chart && ChartDataLabels) {
  Chart.register(ChartDataLabels);
  Chart.defaults.plugins.datalabels = {
  color: '#ffffff',
  font: { weight: 'bold', size: 14 },
  formatter: (value, ctx) => {
    if (value === null || value === undefined || isNaN(value)) return '';

    const chartType = ctx.chart.config.type;

    // PIE / DOUGHNUT -> % of total
    if (chartType === 'pie' || chartType === 'doughnut') {
      const data = ctx.chart.data.datasets[0].data || [];
      const total = data.reduce((a,b)=>a+b,0);
      if (!total) return '';
      return ((value/total)*100).toFixed(1) + '%';
    }

    // BAR charts -> NO percentage label
    return '';
  }
};
}
</script>

</body>
</html>